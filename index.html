<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Bible Plan</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #ffffff;
      --accent: #2c6bed;
      --muted: #8d8d93;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #ffffff;
      color: #1f1f1f;
      -webkit-font-smoothing: antialiased;
    }
    header {
      padding: 2.5rem 1.5rem 1rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
      letter-spacing: 0.04em;
    }
    main {
      flex: 1;
      padding: 0 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .card {
      background: #f8f9fb;
      border-radius: 18px;
      padding: 1.5rem;
      box-shadow: 0 16px 30px rgba(44, 107, 237, 0.06);
    }
    .muted {
      color: var(--muted);
      font-size: 0.9rem;
      letter-spacing: 0.02em;
    }
    .week-label {
      text-transform: uppercase;
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }
    .reading-title {
      font-size: 1.1rem;
      line-height: 1.5;
      margin: 0.5rem 0 1.25rem;
    }
    .primary-button {
      width: 100%;
      border: none;
      border-radius: 12px;
      padding: 1rem;
      background: var(--accent);
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      box-shadow: 0 8px 16px rgba(44, 107, 237, 0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s ease;
      touch-action: manipulation;
    }
    .primary-button:active {
      transform: scale(0.98);
      box-shadow: 0 6px 12px rgba(44, 107, 237, 0.25);
    }
    .primary-button.completed {
      background: #37c871;
      box-shadow: 0 8px 16px rgba(55, 200, 113, 0.25);
    }
    .primary-button:disabled {
      opacity: 0.6;
      box-shadow: none;
    }
    .stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      gap: 1rem;
    }
    .progress-bar {
      position: relative;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e4e7ee;
      overflow: hidden;
      margin-top: 0.75rem;
    }
    .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: inherit;
      background: var(--accent);
      transition: width 0.3s ease;
    }
    nav {
      border-top: 1px solid #eceef3;
      padding: 0.25rem 0.5rem;
      display: flex;
      gap: 0.5rem;
      justify-content: space-between;
      position: sticky;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: saturate(180%) blur(20px);
    }
    .tab-button {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 0.75rem;
      background: transparent;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--muted);
    }
    .tab-button.active {
      color: var(--accent);
      background: rgba(44, 107, 237, 0.08);
    }
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
    .week-list,
    .history-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .history-item,
    .day-item {
      border-radius: 14px;
      padding: 1rem;
      background: #f6f7fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .history-item strong,
    .day-item strong {
      font-size: 0.95rem;
    }
    .checkmark {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid #d1d7e5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: transparent;
      transition: all 0.2s ease;
    }
    .history-item.completed .checkmark,
    .day-item.completed .checkmark {
      background: #37c871;
      border-color: #37c871;
      color: #fff;
      box-shadow: 0 8px 14px rgba(55, 200, 113, 0.3);
    }
    .day-label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .day-label span {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .reset-button {
      margin-top: 1.5rem;
      width: 100%;
      border: none;
      border-radius: 12px;
      background: #f2f3f7;
      color: #d12f2f;
      font-weight: 600;
      padding: 0.75rem;
      font-size: 0.95rem;
    }
    footer {
      padding: 1rem 1.5rem 1.5rem;
      font-size: 0.85rem;
      color: var(--muted);
      text-align: center;
    }
    @media (min-width: 600px) {
      body {
        max-width: 520px;
        margin: 0 auto;
        border-left: 1px solid #f0f1f6;
        border-right: 1px solid #f0f1f6;
      }
      nav {
        border-radius: 20px 20px 0 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Bible Plan</h1>
    <div class="muted" id="today-date"></div>
  </header>
  <main>
    <section class="view active" id="today-view">
      <div class="card">
        <div class="week-label" id="today-week-label">Week 1</div>
        <h2 id="today-title" class="reading-title"></h2>
        <p class="muted" id="today-description"></p>
        <button id="complete-button" class="primary-button"></button>
        <div class="progress-bar" aria-hidden="true">
          <div class="progress-fill" id="week-progress-fill" style="width: 0%"></div>
        </div>
        <div class="stats-row">
          <span id="week-progress-text"></span>
          <span class="muted" id="week-name"></span>
        </div>
      </div>
    </section>

    <section class="view" id="week-view">
      <div class="card">
        <div class="week-label" id="week-view-label">Week 1</div>
        <ul class="week-list" id="week-list"></ul>
      </div>
    </section>

    <section class="view" id="history-view">
      <div class="card">
        <div class="week-label">History</div>
        <ul class="history-list" id="history-list"></ul>
        <button class="reset-button" id="reset-button">Reset Progress</button>
      </div>
    </section>
  </main>

  <nav>
    <button class="tab-button active" data-target="today-view">Today</button>
    <button class="tab-button" data-target="week-view">Week</button>
    <button class="tab-button" data-target="history-view">History</button>
  </nav>

  <footer>
    <span id="total-progress"></span>
  </footer>

  <script>
    const biblePlan = {
      week1: [
        "Genesis 1-2; Psalm 19; Mark 1",
        "Genesis 3-5; Mark 2",
        "Genesis 6-8; Psalm 104; Mark 3",
        "Genesis 9-11; Mark 4",
        "Genesis 12-15; Psalm 148; Mark 5"
      ],
      week2: [
        "Genesis 16-18; Psalm 4; Mark 6",
        "Genesis 19-20; Mark 7",
        "Genesis 21-23; Psalm 34; Mark 8",
        "Genesis 24-25; Mark 9",
        "Genesis 26-28; Psalm 27; Mark 10"
      ],
      week3: [
        "Genesis 29-31; Psalm 84; Mark 11",
        "Genesis 32-34; Mark 12",
        "Genesis 35-37; Psalm 105; Mark 13",
        "Genesis 38-40; Mark 14",
        "Genesis 41-42; Psalm 16; Mark 15"
      ],
      week4: [
        "Genesis 43-45; Psalm 33; Mark 16",
        "Genesis 46-47; Luke 1",
        "Genesis 48-49; Psalm 23; Luke 2",
        "Exodus 1-3; Luke 3",
        "Exodus 4-6; Psalm 90; Luke 4"
      ]
    };

    const planStartDate = new Date('2024-01-01T00:00:00');
    const storageKey = 'bible-plan-progress-v1';
    const daysPerWeek = 5;

    const elements = {
      todayDate: document.getElementById('today-date'),
      todayWeekLabel: document.getElementById('today-week-label'),
      todayTitle: document.getElementById('today-title'),
      todayDescription: document.getElementById('today-description'),
      completeButton: document.getElementById('complete-button'),
      weekProgressFill: document.getElementById('week-progress-fill'),
      weekProgressText: document.getElementById('week-progress-text'),
      weekName: document.getElementById('week-name'),
      weekViewLabel: document.getElementById('week-view-label'),
      weekList: document.getElementById('week-list'),
      historyList: document.getElementById('history-list'),
      totalProgress: document.getElementById('total-progress'),
      resetButton: document.getElementById('reset-button'),
    };

    const weekOrder = Object.keys(biblePlan).sort((a, b) => {
      const getNumber = key => parseInt(key.replace(/[^0-9]/g, ''), 10) || 0;
      return getNumber(a) - getNumber(b);
    });

    const weekdayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

    function formatDateLabel(date) {
      const formatter = new Intl.DateTimeFormat(undefined, {
        weekday: 'long', month: 'long', day: 'numeric'
      });
      return formatter.format(date);
    }

    function loadProgress() {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) {
          return {};
        }
        return JSON.parse(raw) || {};
      } catch (error) {
        console.warn('Unable to read progress from storage', error);
        return {};
      }
    }

    function saveProgress(progress) {
      try {
        localStorage.setItem(storageKey, JSON.stringify(progress));
      } catch (error) {
        console.warn('Unable to save progress', error);
      }
    }

    function getTodayContext(referenceDate = new Date()) {
      const today = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate());
      const diffDays = Math.floor((today - planStartDate) / (1000 * 60 * 60 * 24));
      const safeDiffDays = diffDays < 0 ? 0 : diffDays;
      const weekIndex = Math.floor(safeDiffDays / 7);
      let weekday = ((today.getDay() + 6) % 7);
      if (weekday > 4) {
        weekday = 4;
      }
      return { today, weekIndex, weekday, diffDays };
    }

    function getWeekKey(weekIndex) {
      if (weekIndex < 0) return weekOrder[0];
      if (weekIndex >= weekOrder.length) return weekOrder[weekOrder.length - 1];
      return weekOrder[weekIndex];
    }

    function ensureWeekArray(progress, weekKey) {
      if (!progress[weekKey]) {
        progress[weekKey] = Array.from({ length: daysPerWeek }, () => false);
      }
    }

    function computeTotals(progress) {
      let done = 0;
      let total = 0;
      weekOrder.forEach(weekKey => {
        const entries = biblePlan[weekKey];
        total += entries.length;
        const completions = progress[weekKey] || [];
        completions.forEach(value => { if (value) done += 1; });
      });
      return { done, total };
    }

    function render(progress) {
      const { today, weekIndex, weekday, diffDays } = getTodayContext();
      const weekKey = getWeekKey(weekIndex);
      ensureWeekArray(progress, weekKey);
      const readings = biblePlan[weekKey];
      const weekNumberLabel = weekOrder.indexOf(weekKey) + 1;

      elements.todayDate.textContent = formatDateLabel(today);
      elements.todayWeekLabel.textContent = `Week ${weekNumberLabel}`;
      elements.weekName.textContent = readings ? `${weekdayNames[weekday]} · Week ${weekNumberLabel}` : '';
      elements.weekViewLabel.textContent = `Week ${weekNumberLabel}`;

      const isWeekend = (() => {
        const day = ((today.getDay() + 6) % 7);
        return day > 4;
      })();

      if (!readings) {
        elements.todayTitle.textContent = 'Plan Complete';
        elements.todayDescription.textContent = 'You have finished every scheduled reading in this plan.';
        elements.completeButton.textContent = 'All Done';
        elements.completeButton.disabled = true;
        elements.completeButton.classList.remove('completed');
        elements.completeButton.onclick = null;
      } else if (isWeekend) {
        elements.todayTitle.textContent = 'Rest & Reflect';
        elements.todayDescription.textContent = 'There is no scheduled reading for the weekend. Take time to pray, review, or read freely!';
        elements.completeButton.textContent = 'Enjoy the Weekend';
        elements.completeButton.disabled = true;
        elements.completeButton.classList.remove('completed');
        elements.completeButton.onclick = null;
      } else {
        const dayReading = readings[weekday];
        elements.todayTitle.textContent = dayReading;
        elements.todayDescription.textContent = `Today\'s reading for ${weekdayNames[weekday]}. Mark complete when finished.`;
        const isComplete = progress[weekKey]?.[weekday];
        elements.completeButton.textContent = isComplete ? 'Completed ✔' : 'Mark as Complete';
        elements.completeButton.classList.toggle('completed', Boolean(isComplete));
        elements.completeButton.disabled = false;
        elements.completeButton.onclick = () => {
          progress[weekKey][weekday] = !progress[weekKey][weekday];
          saveProgress(progress);
          render(progress);
        };
      }

      if (readings) {
        const weekCompletionCount = (progress[weekKey] || []).filter(Boolean).length;
        const percent = Math.round((weekCompletionCount / readings.length) * 100);
        elements.weekProgressFill.style.width = `${percent}%`;
        elements.weekProgressText.textContent = `${weekCompletionCount}/${readings.length} days completed`;
      } else {
        elements.weekProgressFill.style.width = '100%';
        elements.weekProgressText.textContent = 'Plan complete';
      }

      renderWeekList(progress, weekKey);
      renderHistory(progress);
      const totals = computeTotals(progress);
      elements.totalProgress.textContent = `${totals.done} of ${totals.total} readings completed`;
    }

    function renderWeekList(progress, weekKey) {
      elements.weekList.innerHTML = '';
      const readings = biblePlan[weekKey] || [];
      readings.forEach((entry, index) => {
        ensureWeekArray(progress, weekKey);
        const li = document.createElement('li');
        li.className = 'day-item' + (progress[weekKey][index] ? ' completed' : '');

        const label = document.createElement('div');
        label.className = 'day-label';
        const title = document.createElement('strong');
        title.textContent = weekdayNames[index];
        const subtitle = document.createElement('span');
        subtitle.textContent = entry;
        label.append(title, subtitle);

        const check = document.createElement('div');
        check.className = 'checkmark';
        check.textContent = '✓';

        li.append(label, check);
        elements.weekList.appendChild(li);
      });
    }

    function renderHistory(progress) {
      elements.historyList.innerHTML = '';
      weekOrder.forEach((weekKey, weekIdx) => {
        const readings = biblePlan[weekKey];
        if (!readings) return;
        ensureWeekArray(progress, weekKey);
        readings.forEach((entry, dayIndex) => {
          const item = document.createElement('li');
          const completed = progress[weekKey][dayIndex];
          item.className = 'history-item' + (completed ? ' completed' : '');

          const dayLabel = document.createElement('div');
          dayLabel.className = 'day-label';
          const title = document.createElement('strong');
          title.textContent = `Week ${weekIdx + 1} · ${weekdayNames[dayIndex]}`;
          const subtitle = document.createElement('span');
          subtitle.textContent = entry;
          dayLabel.append(title, subtitle);

          const mark = document.createElement('div');
          mark.className = 'checkmark';
          mark.textContent = '✓';

          item.append(dayLabel, mark);
          elements.historyList.appendChild(item);
        });
      });
    }

    function initializeTabs(progress) {
      const buttons = Array.from(document.querySelectorAll('.tab-button'));
      const views = Array.from(document.querySelectorAll('.view'));
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          buttons.forEach(btn => btn.classList.toggle('active', btn === button));
          views.forEach(view => view.classList.toggle('active', view.id === button.dataset.target));
          if (button.dataset.target === 'today-view') {
            render(progress);
          }
        });
      });
    }

    function setupReset(progress) {
      elements.resetButton.addEventListener('click', () => {
        if (confirm('Reset all saved progress?')) {
          const empty = {};
          weekOrder.forEach(weekKey => {
            empty[weekKey] = Array.from({ length: daysPerWeek }, () => false);
          });
          saveProgress(empty);
          render(empty);
        }
      });
    }

    function initServiceWorker() {
      if ('serviceWorker' in navigator) {
        const swBlob = new Blob([
          `const CACHE_NAME = 'bible-plan-cache-v1';\n`,
          `const toCache = ['./'];\n`,
          `self.addEventListener('install', event => {\n`,
          `  event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(toCache)));\n`,
          `});\n`,
          `self.addEventListener('activate', event => {\n`,
          `  event.waitUntil(\n`,
          `    caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))))\n`,
          `  );\n`,
          `});\n`,
          `self.addEventListener('fetch', event => {\n`,
          `  event.respondWith(\n`,
          `    caches.match(event.request).then(response => response || fetch(event.request))\n`,
          `  );\n`,
          `});\n`
        ], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(err => console.warn('SW registration failed', err));
      }
    }

    function init() {
      const progress = loadProgress();
      elements.completeButton.onclick = () => {};
      initializeTabs(progress);
      setupReset(progress);
      render(progress);
      initServiceWorker();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
